<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Batalha Espacial V7.9</title>

    <style>
        /* CSS Integrado */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0d0221; overflow: hidden; font-family: 'Consolas', 'Courier New', monospace; color: white; }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: #0d0221; padding: 20px; transition: opacity 0.5s; }
        .hidden { display: none !important; }
        
        h1 { font-size: clamp(2.5em, 10vw, 4em); color: #f923e2; text-shadow: 0 0 5px #f923e2, 0 0 10px #f923e2, 0 0 20px #ff077f, 0 0 30px #ff077f; margin-bottom: 30px; letter-spacing: 4px; }
        .button { background: transparent; border: 2px solid #07dfd8; color: #07dfd8; text-shadow: 0 0 5px #07dfd8; padding: 15px 30px; font-size: clamp(1em, 5vw, 1.2em); border-radius: 0; cursor: pointer; width: 80%; max-width: 300px; margin-top: 15px; transition: background-color 0.3s, color 0.3s, box-shadow 0.3s; }
        .button:hover { background-color: #07dfd8; color: #0d0221; box-shadow: 0 0 20px #07dfd8; }

        #menuScreen input { width: 80%; max-width: 300px; padding: 15px; font-size: 1.1em; border-radius: 0; border: 2px solid #07dfd8; background-color: rgba(0,0,0,0.3); color: white; text-align: center; margin-bottom: 20px; }
        #leaderboardList { list-style: none; width: 90%; max-width: 400px; max-height: 60vh; overflow-y: auto; background-color: rgba(0,0,0,0.3); border: 1px solid #f923e2; padding: 10px; }
        
        /* ----- Elementos do Jogo (UI) ----- */
        #gameContainer.crosshair-cursor { cursor: crosshair; }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        #top-left-ui { position: absolute; top: 10px; left: 10px; font-size: 18px; user-select: none; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; border: 1px solid rgba(249, 35, 226, 0.5); }
        #stats-display { display: flex; gap: 20px; }

        #health-bar-container { width: 220px; height: 24px; background-color: rgba(249, 35, 226, 0.2); border: 1px solid #f923e2; border-radius: 0; position: relative; }
        #health-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #f923e2, #ff8c00); transition: width 0.2s; }
        #health-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px black; }

        #pc-bottom-ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-end; gap: 20px; z-index: 10; }
        #pc-abilities-ui, #pc-upgrades-ui { display: flex; gap: 10px; background-color: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; border: 1px solid rgba(7, 223, 216, 0.5); }
        
        .ability { width: 60px; height: 60px; border: 2px solid #07dfd8; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; }
        .ability .cooldown-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(249, 35, 226, 0.7); display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.1s linear; overflow: hidden; border-radius: 6px; }
        .ability .ability-key { position: absolute; top: 2px; left: 4px; font-size: 0.6em; }
        .ability .count-display { position: absolute; bottom: 2px; right: 4px; font-size: 0.6em; background: rgba(0,0,0,0.7); padding: 1px 3px; border-radius: 4px; }
        
        .upgrade-card { display: flex; flex-direction: column; align-items: center; padding: 10px; background: rgba(30, 30, 30, 0.7); border: 1px solid #ffac33; width: 120px; }
        .upgrade-card.disabled { border-color: #a83232; }
        .upgrade-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .upgrade-icon { font-size: 1.2em; }
        .upgrade-title { font-size: 0.9em; }
        .upgrade-level { font-size: 0.8em; margin-bottom: 8px; }
        .upgrade-buy { display: flex; align-items: center; gap: 10px; }
        .upgrade-buy button { background: #ffac33; border: none; color: black; font-size: 1.5em; width: 30px; height: 30px; cursor: pointer; }
        .upgrade-buy button:disabled { background: #a83232; cursor: not-allowed; }
        .upgrade-cost { font-size: 0.9em; }


        /* Joysticks e Bot√µes Mobile */
        #joystick-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 180px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;}
        .joystick-zone { width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; }
        .joystick-base { width: 100px; height: 100px; background-color: rgba(249, 35, 226, 0.2); border: 2px solid #f923e2; border-radius: 50%; }
        .joystick-stick { width: 50px; height: 50px; background-color: rgba(7, 223, 216, 0.5); border-radius: 50%; position: absolute; }
        
        #mobile-abilities-ui { position: absolute; right: 20px; bottom: 180px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        #mobile-abilities-ui .ability { width: 55px; height: 55px; font-size: 1.2em; }
    </style>
</head>
<body>
    <div id="menuScreen" class="screen">
        <h1>Batalha Espacial</h1>
        <input type="text" id="playerNameInput" placeholder="Digite seu nome">
        <div id="platform-selection"> <button id="startPCButton" class="button">Jogar no PC</button> <button id="startMobileButton" class="button">Jogar no Celular</button> </div>
        <button id="leaderboardButton" class="button">Placar</button>
    </div>
    <div id="leaderboardScreen" class="screen hidden"><h1>Recordes</h1> <ol id="leaderboardList"></ol> <button id="backToMenuButton" class="button">Voltar</button></div>
    <div id="gameOverModal" class="screen hidden"><div id="modalContent"> <h1>Fim de Jogo</h1> <p>Pontua√ß√£o Final: <span id="finalScoreEl">0</span></p> <button id="menuReturnButton" class="button">Voltar ao Menu</button> </div></div>

    <div id="gameContainer" class="hidden">
        <canvas id="gameCanvas"></canvas>
        <div id="top-left-ui">
            <div id="stats-display"> <span>Pontos: <span id="scoreEl">0</span></span> <span>Horda: <span id="waveEl">0</span></span> </div>
            <div id="health-bar-container"> <div id="health-bar"></div> <div id="health-text"></div> </div>
        </div>
        
        <!-- UI para PC -->
        <div id="pc-bottom-ui" class="hidden">
            <div id="upgrades-ui">
                <div class="upgrade-card" id="health-upgrade">
                    <div class="upgrade-header"><span class="upgrade-icon">‚ù§Ô∏è</span><span class="upgrade-title">Vida</span></div>
                    <div class="upgrade-level">Lv1</div>
                    <div class="upgrade-buy"><button>+</button><span class="upgrade-cost"></span></div>
                </div>
                <div class="upgrade-card" id="damage-upgrade">
                     <div class="upgrade-header"><span class="upgrade-icon">üí•</span><span class="upgrade-title">Dano</span></div>
                    <div class="upgrade-level">Lv1</div>
                    <div class="upgrade-buy"><button>+</button><span class="upgrade-cost"></span></div>
                </div>
                <div class="upgrade-card" id="speed-upgrade">
                     <div class="upgrade-header"><span class="upgrade-icon">‚ö°</span><span class="upgrade-title">Velocidade</span></div>
                    <div class="upgrade-level">Lv1</div>
                    <div class="upgrade-buy"><button>+</button><span class="upgrade-cost"></span></div>
                </div>
            </div>
            <div id="pc-abilities-ui">
                <div id="abilities-row">
                    <div id="shield-ability" class="ability">üõ°Ô∏è<div class="cooldown-overlay"></div><span class="ability-key">Q</span></div>
                    <div id="hunter-ability" class="ability">üí•<div class="cooldown-overlay"></div><span class="ability-key">RMB</span></div>
                    <div id="predator-ability" class="ability">üöÄ<div class="cooldown-overlay"></div><span class="ability-key">E/S+X</span><span class="count-display">0</span></div>
                    <div id="flot-ability" class="ability">üõ∞Ô∏è<div class="cooldown-overlay"></div><span class="ability-key">F</span><span class="count-display">0</span></div>
                    <div id="defense-drone-ability" class="ability">üîµ<div class="cooldown-overlay"></div><span class="ability-key">C</span><span class="count-display">0</span></div>
                </div>
            </div>
        </div>

         <!-- UI para Mobile -->
         <div id="mobile-controls" class="hidden">
            <div id="joystick-container">
                <div class="joystick-zone" id="joystick-zone-left"><div class="joystick-base"><div class="joystick-stick"></div></div></div>
                <div class="joystick-zone" id="joystick-zone-right"><div class="joystick-base"><div class="joystick-stick"></div></div></div>
            </div>
             <div id="mobile-abilities-ui">
                <div id="mobile-shield-ability" class="ability">üõ°Ô∏è<div class="cooldown-overlay"></div></div>
                <div id="mobile-hunter-ability" class="ability">üí•<div class="cooldown-overlay"></div></div>
                <div id="mobile-predator-ability" class="ability">üöÄ<span class="count-display">0</span></div>
                <div id="mobile-multi-predator-ability" class="ability">üöÄ<small>xN</small></div>
                <div id="mobile-flot-ability" class="ability">üõ∞Ô∏è<span class="count-display">0</span></div>
                <div id="mobile-defense-drone-ability" class="ability">üîµ<span class="count-display">0</span></div>
            </div>
        </div>
    </div>

    <script>
        const getEl = (id) => document.getElementById(id);
        const menuScreen = getEl('menuScreen'), leaderboardScreen = getEl('leaderboardScreen'), gameContainer = getEl('gameContainer'), gameOverModal = getEl('gameOverModal');
        const startPCButton = getEl('startPCButton'), startMobileButton = getEl('startMobileButton'), leaderboardButton = getEl('leaderboardButton'), backToMenuButton = getEl('backToMenuButton'), menuReturnButton = getEl('menuReturnButton');
        const playerNameInput = getEl('playerNameInput'), canvas = getEl('gameCanvas'), ctx = canvas.getContext('2d');
        const scoreEl = getEl('scoreEl'), waveEl = getEl('waveEl'), finalScoreEl = getEl('finalScoreEl'), healthBar = getEl('health-bar'), healthText = getEl('health-text');
        const pcUI = getEl('pc-bottom-ui'), mobileUI = getEl('mobile-controls');
        
        let player, bosses, bullets, enemies, particles, enemyBullets, explosions, predatorMissiles, flotDrones, defenseDrones, stars, magneticWaves, arietes;
        let score, currentWave, enemyLevel, nextLevelScore, animationId, controlMode, currentPlayerName, missileChargeTimer, shootCooldown, lastHealTime, pointMultiplier;
        let moveJoystick, shootJoystick;
        let waveTransition = { active: false, timer: 0, duration: 5000 };
        const keys = { w: false, a: false, s: false, d: false, q: false, e: false, f: false, '1': false, '2': false, 'c': false, 'shift': false, 'x': false };
        const mouse = { x: 0, y: 0, leftDown: false };
        const abilities = {
            shield: { duration: 20000, cooldown: 30000, active: false, onCooldown: false, timer: 0 },
            hunter: { duration: 20000, cooldown: 30000, active: false, onCooldown: false, timer: 0 },
            predator: { max: 20, current: 0, chargeTime: 5000 },
            flot: { cost: 300, currentCost: 300 },
            defense: { cost: 250, currentCost: 250 }
        };
        const upgrades = { health: { cost: 200, level: 0 }, damage: { cost: 1000, level: 0 }, speed: { cost: 500, level: 0 } };

        // --- NAVEGA√á√ÉO E IN√çCIO ---
        startPCButton.addEventListener('click', () => startGame('pc'));
        startMobileButton.addEventListener('click', () => startGame('mobile'));
        function startGame(mode) {
            currentPlayerName = playerNameInput.value || "Jogador"; controlMode = mode;
            menuScreen.classList.add('hidden'); gameContainer.classList.remove('hidden');
            if (controlMode === 'pc') { 
                pcUI.classList.remove('hidden'); 
                mobileUI.classList.add('hidden');
                gameContainer.classList.add('crosshair-cursor'); 
            } else { 
                pcUI.classList.add('hidden'); 
                mobileUI.classList.remove('hidden');
                gameContainer.classList.remove('crosshair-cursor'); 
            }
            initGame();
        }
        leaderboardButton.addEventListener('click', () => { leaderboardScreen.classList.remove('hidden'); menuScreen.classList.add('hidden'); displayLeaderboard(); });
        backToMenuButton.addEventListener('click', () => { menuScreen.classList.remove('hidden'); leaderboardScreen.classList.add('hidden'); });
        menuReturnButton.addEventListener('click', () => { menuScreen.classList.remove('hidden'); gameOverModal.classList.add('hidden'); gameContainer.classList.add('hidden'); });
        const LEADERBOARD_KEY = 'spaceShooterLeaderboardV6';
        const getScores = () => JSON.parse(localStorage.getItem(LEADERBOARD_KEY) || '[]');
        function saveScore(name, score) { if (score <= 0) return; const scores = getScores(); scores.push({ name, score }); scores.sort((a, b) => b.score - a.score); localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(scores.slice(0, 10))); }
        function displayLeaderboard() { getEl('leaderboardList').innerHTML = getScores().length ? getScores().map(r => `<li><span>${r.name}</span><span>${r.score}</span></li>`).join('') : '<li>Nenhum recorde ainda.</li>'; }
        
        // --- CLASSES ---
        class Player { constructor(x,y){this.x=x;this.y=y;this.radius=15;this.speed=4;this.angle=0;this.maxHp=500;this.hp=500;this.velocity={x:0,y:0};this.damageMultiplier=1;this.lastHitTime=0;} 
            draw(){
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                const bodyGradient = ctx.createLinearGradient(0, -this.radius, 0, this.radius);
                bodyGradient.addColorStop(0, '#E0E0E0');
                bodyGradient.addColorStop(1, '#A0A0A0');
                ctx.fillStyle = bodyGradient;
                ctx.strokeStyle = '#424242';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(0, -18);
                ctx.lineTo(12, 10);
                ctx.lineTo(8, 15);
                ctx.lineTo(-8, 15);
                ctx.lineTo(-12, 10);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(0, -2, 5, 0, Math.PI * 2);
                const cockpitGradient = ctx.createRadialGradient(0, -2, 1, 0, -2, 5);
                cockpitGradient.addColorStop(0, 'rgba(120, 220, 255, 1)');
                cockpitGradient.addColorStop(1, 'rgba(0, 150, 200, 0.5)');
                ctx.fillStyle = cockpitGradient;
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(-7, 7);
                ctx.lineTo(-5, 0);
                ctx.lineTo(5, 0);
                ctx.lineTo(7, 7);
                ctx.strokeStyle = '#BDBDBD';
                ctx.stroke();
                ctx.restore();
                if(abilities.shield.active){ctx.beginPath();ctx.arc(this.x,this.y,this.radius+10,0,Math.PI*2);ctx.strokeStyle=`rgba(0,255,255,${0.2+Math.random()*0.5})`;ctx.lineWidth=3;ctx.stroke();}
            } 
            update(){
                this.draw();
                if (controlMode === 'pc') {
                    this.angle = Math.atan2(mouse.y - this.y, mouse.x - this.x) + Math.PI / 2;
                    this.velocity.x = 0;
                    this.velocity.y = 0;
                    if (keys.w) this.velocity.y = -1;
                    if (keys.s) this.velocity.y = 1;
                    if (keys.a) this.velocity.x = -1;
                    if (keys.d) this.velocity.x = 1;
                } else {
                    this.velocity = moveJoystick.vector;
                    if (shootJoystick.vector.x !== 0 || shootJoystick.vector.y !== 0) {
                        this.angle = Math.atan2(shootJoystick.vector.y, shootJoystick.vector.x) + Math.PI / 2;
                    }
                }
                this.x += this.velocity.x * this.speed;
                this.y += this.velocity.y * this.speed;
                if (this.velocity.x !== 0 || this.velocity.y !== 0) {
                    const r = this.angle - Math.PI / 2;
                    const backOffsetX = Math.cos(r + Math.PI) * 12;
                    const backOffsetY = Math.sin(r + Math.PI) * 12;
                    particles.push(new Particle(this.x + backOffsetX, this.y + backOffsetY, 2.5, 'orange'));
                }
                this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
            } 
            takeDamage(amount){this.lastHitTime=Date.now();this.hp=Math.max(0,this.hp-amount);updateHealthBar();if(this.hp<=0)endGame(true);}}
        class Bullet { constructor(x,y,v,isExplosive=false,dmgMult=1){this.x=x;this.y=y;this.radius=4;this.color=isExplosive?'#FF8C00':'white';this.velocity=v;this.speed=10;this.isExplosive=isExplosive;this.damage=isExplosive?3*dmgMult:1*dmgMult;} draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();} update(){this.draw();this.x+=this.velocity.x*this.speed;this.y+=this.velocity.y*this.speed;} }
        class Enemy { constructor(x,y,level){this.x=x;this.y=y;this.level=level;this.radius=12+level*2;this.health=level*2;this.maxHealth=level*2;this.points=20*Math.pow(2,level-1);this.color=`hsl(${120 - level*20}, 80%, 50%)`;this.shootCooldown=2000-level*200;this.lastShot=Date.now();} 
            draw(){
                ctx.save();
                ctx.translate(this.x, this.y);
                if (player) ctx.rotate(Math.atan2(player.y - this.y, player.x - this.x) + Math.PI / 2);
                ctx.beginPath();
                ctx.moveTo(0, -this.radius); // Ponta
                ctx.quadraticCurveTo(this.radius, 0, 0, this.radius); // Corpo direito
                ctx.quadraticCurveTo(-this.radius, 0, 0, -this.radius); // Corpo esquerdo
                ctx.closePath();
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1.5;
                ctx.stroke();
                ctx.restore();
            }
            update(){this.draw();if(!player) return; const angle=Math.atan2(player.y-this.y,player.x-this.x);const speed=.8+(this.level*.2);this.x+=Math.cos(angle)*speed;this.y+=Math.sin(angle)*speed;if(Date.now()-this.lastShot>this.shootCooldown){this.shoot();this.lastShot=Date.now();}} 
            shoot(){if(!player) return; const angle=Math.atan2(player.y-this.y,player.x-this.x);const damage=2*Math.pow(1.3,this.level-1);enemyBullets.push(new EnemyBullet(this.x,this.y,{x:Math.cos(angle),y:Math.sin(angle)},this.level,damage));}}
        class EnemyBullet { constructor(x,y,v,level,dmg){this.x=x;this.y=y;this.velocity=v;this.level=level;this.damage=dmg;this.radius=4+level;this.speed=3+level*.5;this.isExplosive=level>=3;this.isHoming=level>=4;this.isDoT=level>=5;this.color=this.isDoT?'red':(this.isExplosive?'orange':'magenta'); this.health = this.isHoming ? 3 : 1; } draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();} update(){if(this.isHoming&&player){const angle=Math.atan2(player.y-this.y,player.x-this.x);this.velocity.x=Math.cos(angle);this.velocity.y=Math.sin(angle);}this.draw();this.x+=this.velocity.x*this.speed;this.y+=this.velocity.y*this.speed;}}
        class Particle { constructor(x,y,r,c){this.x=x;this.y=y;this.radius=r;this.color=c;this.velocity={x:(Math.random()-.5)*2,y:(Math.random()-.5)*2};this.alpha=1;this.life=Math.random()*40+20;} draw(){ctx.save();ctx.globalAlpha=this.alpha;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();ctx.restore();} update(){this.draw();this.x+=this.velocity.x;this.y+=this.velocity.y;this.life--; this.alpha=this.life/60;}}
        class Explosion { constructor(x,y,baseRadius){this.x=x;this.y=y;this.baseRadius=baseRadius;this.particles=[];this.alpha=1;this.init();}
            init(){
                const particleCount=this.baseRadius;
                const colors=['#ffffff','#ffc857','#ffac33','#e67700','#d95d00','#bf4700','#222'];
                for(let i=0;i<particleCount;i++){
                    this.particles.push(new Particle(this.x,this.y,Math.random()*2+1,colors[Math.floor(Math.random()*colors.length)]));
                }
            }
            update(){this.particles.forEach((p,i)=>{p.update();if(p.alpha<=0)this.particles.splice(i,1);});this.alpha-=0.04;}}
        class PredatorMissile { constructor(x,y){this.x=x;this.y=y;this.target=null;this.radius=8;this.speed=8;} findTarget(){let bestTarget=null;let maxScore=-1;const targets=[...enemies,...bosses,...arietes];targets.forEach(t=>{if(!t)return;const dist=Math.hypot(this.x-t.x,this.y-t.y);const score=(t.level||10)*100-dist;if(score>maxScore){maxScore=score;bestTarget=t;}});this.target=bestTarget;} update(){if(!this.target||this.target.health<=0)this.findTarget();if(this.target){const angle=Math.atan2(this.target.y-this.y,this.target.x-this.x);this.x+=Math.cos(angle)*this.speed;this.y+=Math.sin(angle)*this.speed;if(Math.hypot(this.x-this.target.x,this.y-this.target.y)<this.speed*2)this.detonate();}else{this.y-=this.speed;if(this.y<0)predatorMissiles.splice(predatorMissiles.indexOf(this),1);}this.draw();} draw(){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.target?Math.atan2(this.target.y-this.y,this.target.x-this.x)+Math.PI/2:0);ctx.fillStyle='white';ctx.beginPath();ctx.moveTo(0,-10);ctx.lineTo(5,5);ctx.lineTo(-5,5);ctx.closePath();ctx.fill();particles.push(new Particle(this.x,this.y,3,'red'));ctx.restore();} detonate(){createExplosion(this.x, this.y, 150);[...enemies, ...bosses, ...arietes].forEach(e=>{if(Math.hypot(this.x-e.x,this.y-e.y)<150)e.health-=30;});predatorMissiles.splice(predatorMissiles.indexOf(this),1);}}
        class Boss { constructor(x,y){this.x=x;this.y=y;this.level=10;this.radius=50;this.maxHealth=2000;this.health=2000;this.color='purple';this.target={x:Math.random()*canvas.width,y:Math.random()*canvas.height};this.speed=1;this.lastShot=Date.now();this.shootCooldown=1000;this.points=2000;} update(){if(Math.hypot(this.x-this.target.x,this.y-this.target.y)<50)this.target={x:Math.random()*canvas.width,y:Math.random()*canvas.height};const angle=Math.atan2(this.target.y-this.y,this.target.x-this.x);this.x+=Math.cos(angle)*this.speed;this.y+=Math.sin(angle)*this.speed;if(Date.now()-this.lastShot>this.shootCooldown)this.shoot();this.draw();} shoot(){this.lastShot=Date.now();if(!player)return;const angle=Math.atan2(player.y-this.y,player.x-this.x);enemyBullets.push(new EnemyBullet(this.x,this.y,{x:Math.cos(angle),y:Math.sin(angle)},4,15));} 
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill();
                ctx.strokeStyle = '#ff00ff'; ctx.lineWidth = 3;
                for(let i=0; i<6; i++) { ctx.beginPath(); const angle = i * (Math.PI*2/6) + Date.now()/1000; ctx.moveTo(Math.cos(angle) * this.radius * 0.6, Math.sin(angle) * this.radius * 0.6); ctx.lineTo(Math.cos(angle) * this.radius, Math.sin(angle) * this.radius); ctx.stroke(); }
                ctx.beginPath(); ctx.arc(0, 0, this.radius, -Math.PI/2, -Math.PI/2 + Math.PI*2*(this.health/this.maxHealth)); ctx.strokeStyle='red'; ctx.lineWidth=8; ctx.stroke();
                ctx.restore();
            }
        }
        class FlotDrone { constructor(x,y){this.x=x;this.y=y;this.radius=8;this.health=100;this.maxHealth=100;this.target=null;this.lastShot=0;this.shootCooldown=500;} findTarget(){let bestTarget=null;let min_dist=Infinity;[...enemies,...bosses,...arietes].forEach(t=>{if(!t)return;const dist=Math.hypot(this.x-t.x,this.y-t.y);if(dist<min_dist){min_dist=dist;bestTarget=t;}});this.target=bestTarget;} update(index, totalDrones){if(!player)return;if(!this.target||this.target.health<=0)this.findTarget();const orbitRadius=80;const orbitAngle=(Date.now()/2000)+(index*(Math.PI*2/totalDrones));const targetX=player.x+Math.cos(orbitAngle)*orbitRadius;const targetY=player.y+Math.sin(orbitAngle)*orbitRadius;const angle=Math.atan2(targetY-this.y,targetX-this.x);this.x+=Math.cos(angle)*3;this.y+=Math.sin(angle)*3;if(this.target&&Date.now()-this.lastShot>this.shootCooldown){this.shoot();this.lastShot=Date.now();}this.draw();} shoot(){if(!this.target)return;const angle=Math.atan2(this.target.y-this.y,this.target.x-this.x);const damage=this.target instanceof Boss || this.target instanceof Ariete ?30:20;bullets.push(new Bullet(this.x,this.y,{x:Math.cos(angle),y:Math.sin(angle)},false,damage/player.damageMultiplier));} 
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Date.now() / 1000);
                ctx.beginPath();
                ctx.rect(-this.radius, -this.radius, this.radius*2, this.radius*2);
                ctx.strokeStyle='lime';
                ctx.lineWidth=2;
                ctx.stroke();
                ctx.fillStyle = `rgba(0, 255, 0, 0.2)`;
                ctx.fill();
                ctx.restore();
            }
        }
        class DefenseDrone { constructor(x,y){this.x=x;this.y=y;this.radius=12;this.health=200;this.maxHealth=200;} update(index,totalDrones){if(!player)return;const orbitRadius=60;const orbitAngle=-(Date.now()/2000)+(index*(Math.PI*2/totalDrones));let targetX=player.x+Math.cos(orbitAngle)*orbitRadius;let targetY=player.y+Math.sin(orbitAngle)*orbitRadius;const angle=Math.atan2(targetY-this.y,targetX-this.x);this.x+=Math.cos(angle)*3;this.y+=Math.sin(angle)*3;this.draw();} draw(){ctx.save();ctx.translate(this.x,this.y);ctx.beginPath();for(let i=0;i<6;i++){ctx.lineTo(this.radius*Math.cos(i*Math.PI/3),this.radius*Math.sin(i*Math.PI/3));}ctx.closePath();ctx.strokeStyle='lightblue';ctx.lineWidth=3;ctx.stroke();ctx.restore();}}
        class MagneticWave { constructor(x,y){this.x=x;this.y=y;this.radius=0;this.maxRadius=300;this.alpha=1;this.hitDrones=[];} update(){this.radius+=5;this.alpha-=0.02;this.draw();} draw(){ctx.save();ctx.globalAlpha=this.alpha;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.strokeStyle='rgba(255,0,255,0.8)';ctx.lineWidth=5;ctx.stroke();ctx.restore();}}
        class MagnetEnemy extends Enemy { constructor(x,y){super(x,y,5);this.shootCooldown=3000;} shoot(){if(!player)return;magneticWaves.push(new MagneticWave(this.x,this.y));}}
        class Ariete extends Enemy {constructor(x,y){super(x,y,6);this.health=2000;this.points=3000;this.radius=30; this.speed=6;} draw(){ctx.save();ctx.translate(this.x,this.y);if(player)ctx.rotate(Math.atan2(player.y-this.y,player.x-this.x));ctx.fillStyle='#888';ctx.beginPath();ctx.rect(-this.radius,-this.radius/2,this.radius*2,this.radius);ctx.fill();ctx.fillStyle='#f00';ctx.beginPath();ctx.arc(this.radius,0,this.radius/2,0,Math.PI*2);ctx.fill();ctx.restore();} onDeath(){createExplosion(this.x,this.y,this.radius*2);const attackDronesToDestroy = Math.floor(Math.random() * (5 - 1 + 1)) + 1; const defenseDronesToDestroy = Math.floor(Math.random() * (10 - 5 + 1)) + 5; for(let i = 0; i < attackDronesToDestroy && flotDrones.length > 0; i++){ flotDrones[0].health = 0; } for(let i = 0; i < defenseDronesToDestroy && defenseDrones.length > 0; i++){ defenseDrones[0].health = 0; }}}
        class Star { constructor(x, y, radius, speed) { this.x=x; this.y=y; this.radius=radius; this.speed=speed; this.alpha=Math.random()*0.5+0.5; } draw() { ctx.save(); ctx.globalAlpha=this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fillStyle='white'; ctx.fill(); ctx.restore(); } update() { this.y += this.speed; if(this.y > canvas.height + this.radius) { this.y = -this.radius; this.x = Math.random() * canvas.width; } this.draw(); } }
        class Joystick { constructor(zone) { this.zone=zone;this.stick=zone.querySelector('.joystick-stick');this.active=false;this.touchId=null;this.vector={x:0,y:0};this.center={x:0,y:0};this.stickPos={x:0,y:0};this.zone.addEventListener('touchstart',this.handleTouchStart.bind(this),{passive: false});this.zone.addEventListener('touchmove',this.handleTouchMove.bind(this),{passive: false});this.zone.addEventListener('touchend',this.handleTouchEnd.bind(this),{passive: false});} handleTouchStart(e){e.preventDefault();if(this.active)return;const touch=e.changedTouches[0];this.active=true;this.touchId=touch.identifier;const rect=this.zone.getBoundingClientRect();this.center={x:rect.left+rect.width/2,y:rect.top+rect.height/2};this.updateStick(touch.clientX,touch.clientY);} handleTouchMove(e){e.preventDefault();if(!this.active)return;const touch=Array.from(e.changedTouches).find(t=>t.identifier===this.touchId);if(touch){this.updateStick(touch.clientX,touch.clientY);}} handleTouchEnd(e){e.preventDefault();const touch=Array.from(e.changedTouches).find(t=>t.identifier===this.touchId);if(touch){this.active=false;this.touchId=null;this.vector={x:0,y:0};this.stick.style.transform=`translate(0px, 0px)`;}} updateStick(x,y){const dx=x-this.center.x;const dy=y-this.center.y;const distance=Math.sqrt(dx*dx+dy*dy);const maxDistance=this.zone.clientWidth/4;const clampedX=this.center.x+(dx/distance)*Math.min(distance,maxDistance);const clampedY=this.center.y+(dy/distance)*Math.min(distance,maxDistance);this.stick.style.transform=`translate(${clampedX-this.center.x}px,${clampedY-this.center.y}px)`;this.vector={x:(clampedX-this.center.x)/maxDistance,y:(clampedY-this.center.y)/maxDistance};}}
        
        // --- CONTROLES E HABILIDADES ---
        window.addEventListener('keydown',(e)=>{const k=e.key.toLowerCase();if(k in keys)keys[k]=true;if(controlMode==='pc'){if(k==='q')activateShield();if(k==='e')activatePredator();if(k==='x'&&keys.shift)launchAllPredators();if(k==='f')activateFlot();if(k==='1')buyHealthUpgrade();if(k==='2')buyDamageUpgrade();if(k==='c')buyDefenseDrone();}});
        window.addEventListener('keyup',(e)=>{const k=e.key.toLowerCase();if(k in keys)keys[k]=false;});
        window.addEventListener('mousemove',(e)=>{mouse.x=e.clientX;mouse.y=e.clientY;});
        window.addEventListener('mousedown',(e)=>{if(controlMode==='pc'){e.button===0?mouse.leftDown=true:activateHunter();}});
        window.addEventListener('mouseup',(e)=>{if(controlMode==='pc'&&e.button===0)mouse.leftDown=false;});
        window.addEventListener('contextmenu',e=>{if(controlMode==='pc')e.preventDefault();});
        getEl('mobile-shield-ability').addEventListener('touchstart', (e) => { e.preventDefault(); activateShield(); });
        getEl('mobile-hunter-ability').addEventListener('touchstart', (e) => { e.preventDefault(); activateHunter(); });
        getEl('mobile-predator-ability').addEventListener('touchstart', (e) => { e.preventDefault(); activatePredator(); });
        getEl('mobile-flot-ability').addEventListener('touchstart', (e) => { e.preventDefault(); activateFlot(); });

        function activateShield(){if(!player || abilities.shield.onCooldown)return;abilities.shield.active=true;abilities.shield.onCooldown=true;abilities.shield.timer=Date.now();setTimeout(()=>abilities.shield.active=false,abilities.shield.duration);setTimeout(()=>abilities.shield.onCooldown=false,abilities.shield.cooldown);}
        function activateHunter(){if(!player || abilities.hunter.onCooldown)return;abilities.hunter.active=true;abilities.hunter.onCooldown=true;abilities.hunter.timer=Date.now();setTimeout(()=>abilities.hunter.active=false,abilities.hunter.duration);setTimeout(()=>abilities.hunter.onCooldown=false,abilities.hunter.cooldown);}
        function activatePredator(){if(!player || abilities.predator.current<=0||predatorMissiles.length>0)return;abilities.predator.current--;predatorMissiles.push(new PredatorMissile(player.x,player.y));}
        function launchAllPredators(){if(!player||abilities.predator.current<=0)return;const numToLaunch=abilities.predator.current;const targets=[...enemies,...bosses,...arietes];for(let i=0;i<numToLaunch;i++){const missile=new PredatorMissile(player.x,player.y);if(targets[i])missile.target=targets[i];predatorMissiles.push(missile);}abilities.predator.current=0;}
        function activateFlot(){if(!player || score < abilities.flot.currentCost)return;updateScore(-abilities.flot.currentCost);flotDrones.push(new FlotDrone(player.x,player.y));}
        function buyDefenseDrone(){if(!player || score < abilities.defense.currentCost)return;updateScore(-abilities.defense.currentCost);defenseDrones.push(new DefenseDrone(player.x,player.y));}

        // --- MELHORIAS ---
        function buyHealthUpgrade(){if(!player || score<upgrades.health.cost)return;updateScore(-upgrades.health.cost);const increase=player.maxHp>=1000?300:50;player.maxHp+=increase;player.hp+=increase;upgrades.health.level++;upgrades.health.cost=player.maxHp>=1000?upgrades.health.cost*2:upgrades.health.cost+100;updateHealthBar();updateUI();}
        function buyDamageUpgrade(){if(!player || score<upgrades.damage.cost)return;updateScore(-upgrades.damage.cost);player.damageMultiplier+=.1;upgrades.damage.level++;upgrades.damage.cost+=500;updateUI();}

        // --- L√ìGICA DO JOGO ---
        function initGame(){
            canvas.width=window.innerWidth;canvas.height=window.innerHeight;
            if(controlMode === 'mobile') {
                moveJoystick = new Joystick(getEl('joystick-zone-left'));
                shootJoystick = new Joystick(getEl('joystick-zone-right'));
            }
            player=new Player(canvas.width/2,canvas.height/2);stars=[];for(let i=0;i<200;i++){stars.push(new Star(Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*1.5,Math.random()*0.5+0.2));}bullets=[];enemies=[];particles=[];enemyBullets=[];explosions=[];flotDrones=[];predatorMissiles=[];bosses=[];defenseDrones=[];magneticWaves=[];arietes=[];score=0;currentWave=0;enemyLevel=1;pointMultiplier=1;nextLevelScore=500;shootCooldown=false;lastHealTime=0;Object.values(abilities).forEach(a=>{a.active=false;a.onCooldown=false;});abilities.predator.current=0;abilities.flot.currentCost=abilities.flot.cost;abilities.defense.currentCost=abilities.defense.cost;upgrades.health.cost=200;upgrades.damage.cost=1000;upgrades.health.level=0;upgrades.damage.level=0;waveTransition.active=false;updateScore(0);updateHealthBar();if(missileChargeTimer)clearInterval(missileChargeTimer);missileChargeTimer=setInterval(()=>{if(abilities.predator.current<abilities.predator.max){abilities.predator.current++;}},abilities.predator.chargeTime);if(animationId)cancelAnimationFrame(animationId);startNextWave();animate();}
        function startNextWave(){currentWave++;waveEl.innerText=currentWave;pointMultiplier*=1.1;if(currentWave>=6){abilities.flot.currentCost=2000;abilities.defense.currentCost=1000;}else{abilities.flot.currentCost=Math.floor(abilities.flot.cost*1.3);abilities.defense.currentCost=Math.floor(abilities.defense.cost*1.3);}const isBossWave=currentWave>0&&currentWave%5===0;if(isBossWave){const bossCount=Math.floor(currentWave/5);for(let i=0;i<bossCount;i++){bosses.push(new Boss(canvas.width/2+(i*150-bossCount*75),100));}spawnEnemies(5,5*bossCount);spawnEnemies(3,5*bossCount);spawnEnemies(2,8*bossCount);spawnEnemies(1,15*bossCount);}else{const spawnCount=currentWave*3;for(let i=0;i<spawnCount;i++){const level=Math.ceil(Math.random()*enemyLevel);spawnEnemies(level,1);}if(currentWave>=10){let arieteCount=Math.floor((currentWave-10)/2)+1;spawnEnemies(6,arieteCount);}}}
        function spawnEnemies(level,count){for(let i=0;i<count;i++){const r=15+level*2;let x,y;if(Math.random()<.5){x=Math.random()<.5?0-r:canvas.width+r;y=Math.random()*canvas.height}else{x=Math.random()*canvas.width;y=Math.random()<.5?0-r:canvas.height+r}if(level===5){enemies.push(new MagnetEnemy(x,y));}else if(level===6){arietes.push(new Ariete(x,y));}else{enemies.push(new Enemy(x,y,level));}}}
        function handleShooting(){if(!player)return;let fire=false;let angle=0;if(controlMode==='pc'&&mouse.leftDown){fire=true;angle=Math.atan2(mouse.y-player.y,mouse.x-player.x);}else if(controlMode==='mobile'&&shootJoystick&& (shootJoystick.vector.x!==0||shootJoystick.vector.y!==0)){fire=true;angle=Math.atan2(shootJoystick.vector.y,shootJoystick.vector.x);}if(!fire)return;const r=player.angle-Math.PI/2;const nX=player.x+Math.cos(r)*player.radius,nY=player.y+Math.sin(r)*player.radius;if(abilities.hunter.active){for(let i=-2;i<=2;i++)bullets.push(new Bullet(nX,nY,{x:Math.cos(angle+i*.15),y:Math.sin(angle+i*.15)},true,player.damageMultiplier));}else{bullets.push(new Bullet(nX,nY,{x:Math.cos(angle),y:Math.sin(angle)},false,player.damageMultiplier));}}
        
        function animate(){
            animationId = requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            stars.forEach(s => s.update());
            
            const gameArrays = { particles, explosions, bullets, enemyBullets, enemies, bosses, magneticWaves, arietes, flotDrones, defenseDrones, predatorMissiles };
            for (const key in gameArrays) {
                for (let i = gameArrays[key].length - 1; i >= 0; i--) {
                    const item = gameArrays[key][i];
                    if(!item) continue;
                    
                    if (key === 'flotDrones' || key === 'defenseDrones') {
                        item.update(i, gameArrays[key].length);
                    } else {
                        item.update();
                    }

                    if (item.health <= 0 || item.alpha <= 0 || (item instanceof PredatorMissile && !item.target && item.y < 0) ) {
                        if(item instanceof Ariete){ item.onDeath(); updateScore(item.points); }
                        else if(item instanceof Enemy) { createExplosion(item.x, item.y, item.radius); updateScore(item.points); }
                        else if(item instanceof Boss) { createExplosion(item.x, item.y, item.radius * 1.5); updateScore(item.points); }
                        else if(item instanceof FlotDrone || item instanceof DefenseDrone) { createExplosion(item.x, item.y, item.radius); }
                        gameArrays[key].splice(i, 1);
                    }
                }
            }
            
            if (player) player.update();
            
            if (waveTransition.active) {
                const timeRemaining = (waveTransition.duration - (Date.now() - waveTransition.timer)) / 1000;
                if (timeRemaining <= 0) {
                    waveTransition.active = false;
                    startNextWave();
                } else {
                    ctx.font = "40px 'Segoe UI'";
                    ctx.fillStyle = "white";
                    ctx.textAlign = "center";
                    ctx.fillText(`Pr√≥xima Horda em ${Math.ceil(timeRemaining)}...`, canvas.width / 2, canvas.height / 2);
                }
            } else {
                if (player && Date.now() - player.lastHitTime > 2000 && player.hp < player.maxHp && Date.now() - lastHealTime > 500) {
                    player.hp = Math.min(player.maxHp, player.hp + 100);
                    lastHealTime = Date.now();
                    updateHealthBar();
                }

                if (!shootCooldown && player) {
                    handleShooting();
                    shootCooldown = true;
                    setTimeout(() => shootCooldown = false, abilities.hunter.active ? 300 : 150);
                }
                checkCollisions();
                 if (player && enemies.length === 0 && bosses.length === 0 && arietes.length === 0) {
                    waveTransition.active = true;
                    waveTransition.timer = Date.now();
                }
            }
            
            updateUI();
        }
        
        function checkCollisions(){if(!player)return;[...bosses, ...arietes].forEach((b)=>{if(Math.hypot(player.x-b.x,player.y-b.y)-b.radius-player.radius<1){if(b instanceof Boss) endGame(true); else b.health=0; return;}bullets.forEach((bullet,bulletI)=>{if(Math.hypot(bullet.x-b.x,bullet.y-b.y)-b.radius-bullet.radius<1){b.health-=bullet.damage;bullets.splice(bulletI,1);}});});enemies.forEach((e)=>{if(Math.hypot(player.x-e.x,player.y-e.y)-e.radius-player.radius<1){player.takeDamage(15);e.health=0;return;}bullets.forEach((b,bI)=>{if(Math.hypot(b.x-e.x,b.y-e.y)-e.radius-b.radius<1){e.health-=b.damage;if(b.isExplosive){createExplosion(b.x,b.y,10);enemies.forEach(oE=>{if(oE!==e&&Math.hypot(b.x-oE.x,b.y-oE.y)<50)oE.health-=.5*player.damageMultiplier});}bullets.splice(bI,1);}});});enemyBullets.forEach((eb,ebI)=>{if(eb.isHoming){bullets.forEach((b,bI)=>{if(Math.hypot(b.x-eb.x,b.y-eb.y)-eb.radius-b.radius<1){eb.health-=b.damage;bullets.splice(bI,1);}});}if(Math.hypot(player.x-eb.x,player.y-eb.y)-player.radius-eb.radius<1){if(!abilities.shield.active)player.takeDamage(eb.damage);if(eb.isExplosive&&!abilities.shield.active)createExplosion(eb.x,eb.y,10);enemyBullets.splice(ebI,1);return;}defenseDrones.forEach((d,dI)=>{if(Math.hypot(d.x-eb.x,d.y-eb.y)-d.radius-eb.radius<1){d.health-=eb.damage;enemyBullets.splice(ebI,1);}});});magneticWaves.forEach((mw)=>{[...flotDrones,...defenseDrones].forEach(d=>{if(!mw.hitDrones.includes(d)&&Math.hypot(mw.x-d.x,mw.y-d.y)<mw.radius){d.health-=d.maxHealth*0.25;mw.hitDrones.push(d);}});});}
        
        function createExplosion(x,y,radius){const particleCount=radius;const colors=['#ffffff','#ffc857','#ffac33','#e67700','#d95d00','#bf4700','#222'];for(let i=0;i<particleCount;i++){particles.push(new Particle(x,y,Math.random()*2+1,colors[Math.floor(Math.random()*colors.length)]));}}
        function updateScore(points){if(!player) return; score+=Math.floor(points * pointMultiplier);scoreEl.innerText=score;if(score>=nextLevelScore){enemyLevel=Math.min(5,enemyLevel+1);nextLevelScore+=750;}}
        function updateHealthBar(){if(!player) return; const hp=Math.max(0,player.hp);const p=hp/player.maxHp;healthBar.style.width=`${p*100}%`;healthBar.style.backgroundColor=p>.5?'#4CAF50':(p>.2?'#FFC107':'#F44336');healthText.innerText=`${Math.ceil(hp)}/${player.maxHp} HP`;}
        function updateUI(){
            const abilityUIs = controlMode === 'pc' ? {
                shield: getEl('shield-ability'), hunter: getEl('hunter-ability'), predator: getEl('predator-ability'), flot: getEl('flot-ability'), defense: getEl('defense-drone-upgrade')
            } : {
                shield: getEl('mobile-shield-ability'), hunter: getEl('mobile-hunter-ability'), predator: getEl('mobile-predator-ability'), flot: getEl('mobile-flot-ability')
            };
            Object.entries(abilities).forEach(([key,ability])=>{const ui=abilityUIs[key];if(!ui)return;const overlay=ui.querySelector('.cooldown-overlay');const countEl = ui.querySelector('.count-display');if(key==='predator'){if(countEl)countEl.innerText=ability.current;}else if(key==='flot'){if(countEl)countEl.innerText=`${flotDrones.length}`;const costEl=getEl('flot-ability').querySelector('.cost-display');if(costEl)costEl.innerText=`${abilities.flot.currentCost}P`;}if(ability.onCooldown&&overlay){overlay.style.display='flex';const timePassed=Date.now()-ability.timer;const cd=ability.active?ability.duration:ability.cooldown;const percent=1-(timePassed/cd);overlay.style.height=`${percent*100}%`;overlay.textContent=ability.active?`${((ability.duration-timePassed)/1000).toFixed(1)}s`:`${((ability.cooldown-timePassed)/1000).toFixed(1)}s`;}else if(overlay){overlay.style.display='none';}});
            if(controlMode==='pc'){getEl('health-upgrade').innerText=`[1] HP+ | ${upgrades.health.cost} Pts`;getEl('damage-upgrade').innerText=`[2] Dano+ | ${upgrades.damage.cost} Pts`;getEl('defense-drone-upgrade').innerText=`[C] Drone Def. | ${abilities.defense.currentCost} Pts (${defenseDrones.length})`;}
        }
        function endGame(returnToMenu=false){if(!player)return;saveScore(currentPlayerName,score);finalScoreEl.innerText=score;player=null;cancelAnimationFrame(animationId);clearInterval(missileChargeTimer);if(returnToMenu){menuReturnButton.click();}else{gameOverModal.classList.remove('hidden');}}
        window.addEventListener('resize',()=>{if(!gameContainer.classList.contains('hidden'))initGame();});
    </script>
</body>
</html>
